<style>
/* 弹窗样式调整 */
.layui-layer {
    top: 50% !important;
    transform: translateY(-50%) !important;
    margin-top: 0 !important;
}

/* 限制弹窗最大高度 */
.layui-layer-content {
    max-height: 85vh;
    overflow-y: auto;
}

/* 详情容器样式 */
.device-detail-container {
    max-height: 80vh;
    overflow-y: auto;
    padding: 20px;
}
</style>

<!-- 设备详情弹窗内容 -->
<div class="device-detail-container">
<div class="layui-row layui-col-space15">
    <!-- 设备基本信息 -->
    <div class="layui-col-xs12 layui-col-md8">
        <div class="layui-card">
            <div class="layui-card-header">
                <h3>设备基本信息</h3>
            </div>
            <div class="layui-card-body">
                <table class="layui-table" lay-skin="line">
                    <tbody>
                        <tr>
                            <td width="120">设备名称</td>
                            <td>{$device.device_name}</td>
                        </tr>
                        <tr>
                            <td>设备编号</td>
                            <td>{$device.device_number}</td>
                        </tr>
                        <tr>
                            <td>设备分类</td>
                            <td>
                                {if $device.classify}
                                    {$device.classify.classify_name}
                                {else}
                                    <span class="layui-badge layui-bg-gray">未分类</span>
                                {/if}
                            </td>
                        </tr>
                        <tr>
                            <td>设备分组</td>
                            <td>
                                {if $device.group}
                                    {$device.group.group_name}
                                {else}
                                    <span class="layui-badge layui-bg-gray">未分组</span>
                                {/if}
                            </td>
                        </tr>
                        <tr>
                            <td>设备规格</td>
                            <td>
                                {if $device.spec eq 1}
                                    <span class="layui-badge layui-bg-blue">横屏</span>
                                {elseif $device.spec eq 2}
                                    <span class="layui-badge layui-bg-orange">竖屏</span>
                                {else}
                                    <span class="layui-badge">未知</span>
                                {/if}
                            </td>
                        </tr>
                        <tr>
                            <td>设备状态</td>
                            <td>
                                {if $device.status eq 1}
                                    <span class="layui-badge layui-bg-green">启用</span>
                                {else}
                                    <span class="layui-badge">禁用</span>
                                {/if}
                            </td>
                        </tr>
                        <tr>
                            <td>启用小智AI</td>
                            <td>
                                {if $device.enable_xiaozhi eq 1}
                                    <span class="layui-badge layui-bg-green">已启用</span>
                                {else}
                                    <span class="layui-badge layui-bg-gray">未启用</span>
                                {/if}
                            </td>
                        </tr>
                        <tr>
                            <td>小智连接状态</td>
                            <td>
                                {if $device.xiaozhi_status eq 'connected'}
                                    <span class="layui-badge layui-bg-green">已连接</span>
                                {elseif $device.xiaozhi_status eq 'disconnected'}
                                    <span class="layui-badge layui-bg-gray">未连接</span>
                                {elseif $device.xiaozhi_status eq 'error'}
                                    <span class="layui-badge layui-bg-red">连接错误</span>
                                {else}
                                    <span class="layui-badge">未知</span>
                                {/if}
                            </td>
                        </tr>
                        <tr>
                            <td>最后连接时间</td>
                            <td>
                                {if $device.xiaozhi_last_connect_time}
                                    {$device.xiaozhi_last_connect_time|date='Y-m-d H:i:s'}
                                {else}
                                    <span class="layui-badge layui-bg-gray">从未连接</span>
                                {/if}
                            </td>
                        </tr>
                        <tr>
                            <td>最后断开时间</td>
                            <td>
                                {if $device.xiaozhi_last_disconnect_time}
                                    {$device.xiaozhi_last_disconnect_time|date='Y-m-d H:i:s'}
                                {else}
                                    <span class="layui-badge layui-bg-gray">从未断开</span>
                                {/if}
                            </td>
                        </tr>
                        <tr>
                            <td>创建时间</td>
                            <td>{$device.create_time|date='Y-m-d H:i:s'}</td>
                        </tr>
                        <tr>
                            <td>更新时间</td>
                            <td>{$device.update_time|date='Y-m-d H:i:s'}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 设备统计信息 -->
    <div class="layui-col-xs12 layui-col-md4">
        <div class="layui-card">
            <div class="layui-card-header">
                <h3>执行统计</h3>
            </div>
            <div class="layui-card-body">
                <div class="layui-row layui-col-space10">
                    <div class="layui-col-xs6">
                        <div class="layui-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center;">
                            <div class="layui-card-body">
                                <div style="font-size: 24px; font-weight: bold;">{$executedStats.total}</div>
                                <div>总指令数</div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-xs6">
                        <div class="layui-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; text-align: center;">
                            <div class="layui-card-body">
                                <div style="font-size: 24px; font-weight: bold;">{$executedStats.executed}</div>
                                <div>已执行</div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-xs6">
                        <div class="layui-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; text-align: center;">
                            <div class="layui-card-body">
                                <div style="font-size: 24px; font-weight: bold;">{$executedStats.pending}</div>
                                <div>待执行</div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-xs6">
                        <div class="layui-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; text-align: center;">
                            <div class="layui-card-body">
                                <div style="font-size: 24px; font-weight: bold;">{$executedStats.executed_rate}%</div>
                                <div>执行率</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="layui-row layui-col-space15">
    <!-- 设备指令 -->
    <div class="layui-col-xs12 layui-col-md6">
        <div class="layui-card">
            <div class="layui-card-header">
                <h3>设备指令</h3>
            </div>
            <div class="layui-card-body">
                {if $deviceInstructs}
                <table class="layui-table" lay-skin="line">
                    <thead>
                        <tr>
                            <th>指令名称</th>
                            <th>指令编码</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {foreach $deviceInstructs as $instruct}
                        <tr>
                            <td>{$instruct.instruct.instruct_name}</td>
                            <td>{$instruct.instruct.instruct_code}</td>
                            <td>
                                <button class="layui-btn layui-btn-xs layui-btn-normal" onclick="sendInstruct({$instruct.instruct.id})">
                                    发送指令
                                </button>
                            </td>
                        </tr>
                        {/foreach}
                    </tbody>
                </table>
                {else}
                <div class="layui-empty">
                    <div class="layui-empty-text">暂无关联指令</div>
                </div>
                {/if}
            </div>
        </div>
    </div>

    <!-- 设备日志 -->
    <div class="layui-col-xs12 layui-col-md6">
        <div class="layui-card">
            <div class="layui-card-header">
                <h3>最近日志</h3>
            </div>
            <div class="layui-card-body">
                {if $deviceLogs}
                <table class="layui-table" lay-skin="line">
                    <thead>
                        <tr>
                            <th>指令</th>
                            <th>状态</th>
                            <th>时间</th>
                        </tr>
                    </thead>
                    <tbody>
                        {foreach $deviceLogs as $log}
                        <tr>
                            <td>{$log.instruct.instruct_name}</td>
                            <td>
                                {if $log.executed_status eq 1}
                                    <span class="layui-badge layui-bg-green">已执行</span>
                                {else}
                                    <span class="layui-badge layui-bg-orange">未执行</span>
                                {/if}
                            </td>
                            <td>{$log.create_time|date='m-d H:i'}</td>
                        </tr>
                        {/foreach}
                    </tbody>
                </table>
                {else}
                <div class="layui-empty">
                    <div class="layui-empty-text">暂无日志记录</div>
                </div>
                {/if}
            </div>
        </div>
    </div>
</div>
</div>

<script>
function sendInstruct(instructId) {
    layer.confirm('确定要发送这个指令吗？', function(index) {
        $.post('{:url("sendInstruct")}', {
            device_id: {$device.id},
            instruct_id: instructId
        }, function(res) {
            if (res.code === 1) {
                layer.msg(res.info, {icon: 1});
                // 刷新页面
                setTimeout(function() {
                    location.reload();
                }, 1000);
            } else {
                layer.msg(res.info, {icon: 2});
            }
        });
        layer.close(index);
    });
}
</script>
