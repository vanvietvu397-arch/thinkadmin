{extend name="main"}

{block name='content'}
<style>
.chart-container {
    height: 60vh; /* 使用视口高度的60% */
    min-height: 400px;
    max-height: 800px;
}
#main8 {
    height: 100% !important;
}
</style>
<div class="think-box-shadow portal-block-container notselect">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-sm6 layui-col-md3">
            <div class="portal-block-item nowrap" style="background:linear-gradient(-125deg,#57bdbf,#2f9de2)">
                <div>设备总量</div>
                <div>8</div>
                <div>当前设备总数量</div>
            </div>
            <i class="portal-block-icon layui-icon layui-icon-app"></i>
        </div>
        <div class="layui-col-sm6 layui-col-md3">
            <div class="portal-block-item nowrap" style="background:linear-gradient(-125deg,#ff7d7d,#fb2c95)">
                <div>在线总量</div>
                <div>6</div>
                <div>当前在线总数量</div>
            </div>
            <i class="portal-block-icon layui-icon layui-icon-user"></i>
        </div>
        <div class="layui-col-sm6 layui-col-md3">
            <div class="portal-block-item nowrap" style="background:linear-gradient(-113deg,#c543d8,#925cc3)">
                <div>模板总量</div>
                <div>54</div>
                <div>当前模板总数量</div>
            </div>
            <i class="portal-block-icon layui-icon layui-icon-form"></i>
        </div>
        <div class="layui-col-sm6 layui-col-md3">
            <div class="portal-block-item nowrap" style="background:linear-gradient(-141deg,#ecca1b,#f39526)">
                <div>语音匹配</div>
                <div>12</div>
                <div>语音匹配总数量</div>
            </div>
            <i class="portal-block-icon layui-icon layui-icon-rmb"></i>
        </div>
    </div>
</div>

<div class="layui-row layui-col-space15 ta-mt-10">

    <div class="layui-col-xs12 ta-pb-0">
        <div class="think-box-shadow chart-container">
            <div id="main8" style="width:100%;height:100%"></div>
        </div>
    </div>
</div>

<label class="layui-hide">
    <textarea id="jsondata1">{$days|json_encode}</textarea>
    <textarea id="jsondata2">{$levels|json_encode}</textarea>
</label>

<script>

    require(['echarts'], function (echarts) {
        let data1, days;
        
        try {
            data1 = JSON.parse($('#jsondata1').html());
            if (data1 && data1.length > 0) {
                days = data1.map(function (item) {
            return item['当天日期'];
        });
                console.log('使用后端数据');
            } else {
                throw new Error('后端数据为空');
            }
        } catch (e) {
            console.warn('后端数据解析失败，使用模拟数据:', e.message);
            data1 = [];
            days = [];
        }
        
        // 强制使用模拟数据进行测试
        console.log('强制生成模拟数据');
        data1 = [];
        days = [];
        for (let i = 9; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            days.push(dateStr);
            data1.push({
                '当天日期': dateStr,
                '剩余余额': Math.floor(Math.random() * 50) + 20, // 20-70台设备
                '在线设备数': Math.floor(Math.random() * 50) + 20
            });
        }
        
        // 调试：查看数据结构
        console.log('数据样本:', data1[0]);
        console.log('可用字段:', Object.keys(data1[0] || {}));







        (function (charts) {
            console.log('开始初始化图表');
            console.log('图表数据:', data1);
            console.log('日期数据:', days);
            
            window.addEventListener("resize", function () {
                charts.resize()
            });
            
            const option = {
                grid: [{left: '10%', right: '3%', top: '25%'}],
                title: [{left: 'center', text: '近十天设备在线趋势'}],
                tooltip: {trigger: 'axis'},
                xAxis: [{data: days, gridIndex: 0}],
                yAxis: [{type: 'value', splitLine: {show: true}, gridIndex: 0, axisLabel: {formatter: '{value} 台'}}],
                series: [
                    {
                        type: 'line',
                        smooth: true, showBackground: true,
                        areaStyle: {color: 'rgba(180, 180, 180, 0.5)'},
                        label: {formatter: '{c} 台', showSymbol: false, show: true},
                        data: data1.map(function (item) {
                            return item['剩余余额'] || item['在线设备数'] || 0;
                        }),
                        markLine: {
                            data: [[
                                {x: '90%', symbol: 'none', yAxis: 'max'},
                                {symbol: 'circle', label: {position: 'start', formatter: '最大 {c} 台'}, type: 'max', name: '最高点'}
                            ]]
                        }
                    }
                ]
            };
            
            console.log('图表配置:', option);
            charts.setOption(option);
            console.log('图表初始化完成');
        })(echarts.init(document.getElementById('main8')));
    });
</script>

{/block}
